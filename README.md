## Tech stack / Технологический стек

- Python 3.13 (подойдёт любая актуальная 3.x, но проект развёрнут и тестировался на 3.13).
- Django 5.2.9 — основной web‑фреймворк.
- SQLite (файл `db.sql` в корне) — простая встроенная база данных по умолчанию; для запуска не нужен отдельный сервис.
- pytest + pytest-django — основная тестовая инфраструктура (юнит‑тесты и интеграционные сценарии в каталоге `tests/`).
- HTML‑шаблоны Django + статический CSS из директории `static/` — фронтенд без SPA и тяжёлого JavaScript.
- Docker + docker compose — контейнеризация приложения, запуск dev‑окружения и тестов.

## Quick start (без Docker) / Quick start (without Docker)

Ниже описан полностью локальный запуск напрямую через Python и Django, без использования Docker.

### 1. Зависимости

- Установите Python 3.13 (или ближайшую 3.x) и `pip`.
- Рекомендуется использовать виртуальное окружение, чтобы изолировать зависимости проекта.

### 2. Клонирование проекта

Если репозиторий ещё не скачан:

```bash
git clone <url-репозитория> social-players
cd social-players
```

(Если вы уже находитесь в каталоге проекта, этот шаг можно пропустить.)

### 3. Создание и активация виртуального окружения

**Windows (PowerShell):**

```bash
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```

**Linux/macOS (bash/zsh):**

```bash
python -m venv .venv
source .venv/bin/activate
```

После активации виртуального окружения приглашение командной строки обычно содержит префикс `(.venv)`.

### 4. Установка зависимостей проекта

Все зависимости перечислены в `requirements.txt`. Установите их одной командой:

```bash
pip install -r requirements.txt
```

Если вы работаете за прокси или с нестабильной сетью, убедитесь, что `pip` может скачивать пакеты с PyPI.

### 5. Подготовка базы данных

По умолчанию проект использует `sqlite` с файлом базы `db.sql` в корне репозитория (см. `social_players/settings.py`). Для инициализации базы достаточно прогнать миграции:

```bash
python manage.py migrate
```

Команда создаст и/или обновит файл `db.sql` и все необходимые таблицы.

При необходимости вы можете удалить файл `db.sql` и выполнить миграции заново — это удобно, если хотите получить «чистую» базу.

### 6. Создание суперпользователя (опционально)

Чтобы зайти в стандартную админку Django (`/admin`) и администрировать данные, создайте суперпользователя:

```bash
python manage.py createsuperuser
```

Следуйте интерактивным подсказкам (логин, e‑mail, пароль).

### 7. Запуск dev‑сервера

Запустите локальный сервер разработки:

```bash
python manage.py runserver
```

По умолчанию приложение будет доступно по адресу `http://127.0.0.1:8000/`.

- Страница логина и регистрации — в разделе Accounts.
- Основная лента постов — главная страница (`/`).
- Поиск — `/search/` (обрабатывается в приложении `core`).

Остановить сервер можно сочетанием `Ctrl + C` в терминале.

---

## Docker usage / Использование Docker

Для единообразного окружения проект поставляется с готовой конфигурацией Docker.

### 1. Базовые файлы Docker

В корне репозитория находятся:

- `Dockerfile` — сборка образа с Python, зависимостями и кодом проекта.
- `docker-compose.yml` — сервисы `web` (Django) и `nginx` (reverse proxy + статика/медиа).
- `.dockerignore` — исключения (`.venv`, кэши, временные файлы), чтобы не засорять образ.
- `entrypoint.sh` — скрипт, который выполняет миграции и (опционально) сборку статических файлов.

### 2. Сборка образа

Собрать Docker‑образ можно командой:

```bash
docker compose build
```

Команда:

- Использует официальный базовый образ `python:3.13-slim`.
- Копирует `requirements.txt` и устанавливает зависимости через:

```bash
pip install --no-cache-dir -r requirements.txt
```

- Копирует весь код проекта в контейнер и делает `entrypoint.sh` исполняемым.
- Открывает порт `8000`.

### 3. Запуск приложения в Docker

Чтобы поднять приложение и сразу увидеть результат в браузере:

```bash
docker compose up
```

При запуске:

- `entrypoint.sh` автоматически выполняет `python manage.py migrate --noinput`, поэтому база данных в контейнере всегда в актуальном состоянии.
- При необходимости можно включить сборку статических файлов, установив одну из переменных окружения:
  - `COLLECT_STATIC=1`
  - или `DJANGO_COLLECTSTATIC=1`

Например:

```bash
COLLECT_STATIC=1 docker compose up
```

После успешного запуска приложение будет доступно по адресу `http://127.0.0.1:8000/` (порт проброшен из контейнера: `8000:8000`).

### 3.1 Multi-container layout and ports

`docker compose up` поднимает два сервиса:

- `web` — стандартный Django dev server на `http://127.0.0.1:8000/`.
- `nginx` — reverse proxy на `http://127.0.0.1:8080/`, который раздает `/static/` из общего тома `staticfiles`, `/media/` из bind-монта `./media:/app/media`, а остальные запросы проксирует в `web:8000`.

Все загруженные аватары и другие медиа лежат в каталоге `./media`. Он примонтирован в оба контейнера, поэтому файлы, добавленные локально, сразу доступны в Docker, и наоборот — загрузки из контейнера появляются на хосте.

### 4. Выполнение одноразовых команд в контейнере

Иногда удобно выполнить миграции или тесты из изолированного окружения контейнера:

```bash
docker compose run --rm web python manage.py migrate
```

В этой команде:

- `web` — имя сервиса из `docker-compose.yml`.
- `--rm` говорит Docker удалить временный контейнер после завершения команды.

Вы также можете открыть интерактивный shell внутри контейнера:

```bash
docker compose run --rm web bash
```

### 5. Среда и тома в Docker

Сервис `web` использует следующие настройки:

- `DJANGO_SETTINGS_MODULE=social_players.settings` — стандартный модуль настроек Django.
- `PYTHONUNBUFFERED=1` и `PYTHONDONTWRITEBYTECODE=1` — удобные флаги для работы в контейнере.

Основные тома:

- `.:/app` — исходный код монтируется в контейнер (удобно для разработки: изменения в коде сразу доступны внутри).
- `./media:/app/media` — bind-монтаж медиа (аватары, фото и т.п.) из хоста в оба контейнера, чтобы файлы не терялись и оставались видимыми.
- `staticfiles:/app/staticfiles` — результирующая директория `collectstatic` для production‑подобного режима, общая для `web` и `nginx`.

---

## Testing / Тестирование

Система тестирования построена на `pytest` и `pytest-django`. Все основные сценарии проекта покрыты тестами в каталоге `tests/`.

### 1. Запуск тестов локально (без Docker)

Находясь в корне проекта и при активированном виртуальном окружении:

```bash
pytest
```

Эта команда:

- Автоматически поднимает временную базу данных.
- Запускает весь набор тестов: модели, формы, вьюхи, бизнес‑сценарии и проверку документации/конфигурации Docker.

Вы можете запускать только отдельные файлы или группы тестов, например:

```bash
pytest tests/test_flows.py
pytest tests/test_docs_and_docker.py
```

### 2. Запуск тестов в Docker

Чтобы прогнать тесты в контейнере (с использованием того же окружения, в котором работает приложение):

```bash
docker compose run --rm web pytest
# или, чтобы переиспользовать один и тот же контейнер:
docker compose run web pytest
```

Здесь строка `docker compose run web pytest` важна также для проверки README автоматическим тестом.

### 3. Что покрывают тесты

Основные группы тестов:

- `tests/test_flows.py` — сквозные пользовательские сценарии:
  - регистрация и автоматическое создание профиля;
  - редактирование профиля;
  - отправка/подтверждение/удаление дружбы;
  - создание постов, лайки и комментарии;
  - личные сообщения, отправка текста и фотографий, валидация обязательных полей;
  - невозможность редактировать чужой пост.
- `tests/test_docs_and_docker.py` — контроль того, что Docker‑артефакты и README находятся в консистентном состоянии (команды сборки, запуска, тестирования присутствуют и концептуально корректны).
- Дополнительные тесты по приложениям (`accounts`, `profiles`, `friendships`, `posts`, `messaging`, `core`) могут быть разбросаны по отдельным файлам.

Цель проекта — максимально возможное покрытие кода и пользовательских сценариев (ориентир — 100% coverage), при этом тесты должны быть быстрыми и детерминированными.

---

## Project structure / Структура проекта

Краткий обзор ключевых директорий и модулей.

- `social_players/` — корневой Django‑проект:
  - `settings.py` — настройки Django (SQLite `db.sql`, `STATIC_ROOT`, `MEDIA_ROOT` и др.).
  - `urls.py` — маршрутизация на приложения `accounts`, `profiles`, `friendships`, `posts`, `messaging`, `core`.
  - `wsgi.py` / `asgi.py` — точки входа для серверов.
- `accounts/` — регистрация, логин/логаут, базовые шаблоны форм аутентификации.
- `profiles/` — профили пользователей:
  - модель `Profile` с аватаром, био и отображаемым именем;
  - страница редактирования профиля;
  - отображение счётчиков друзей/подписчиков.
- `friendships/` — вся логика «друзей»:
  - модель дружбы и заявки в друзья (`FriendRequest`, `Friendship`);
  - отправка, принятие, отклонение, отмена заявок;
  - удаление из друзей.
- `posts/` — система постов и ленты:
  - модель `Post` с тематикой (`TOPIC_CHOICES` — CS2, Valorant, Apex Legends, Dota 2, Minecraft и др.);
  - лайки (`Like`) и комментарии (`Comment`) с возможностью прикреплять файлы;
  - представления ленты, создания/редактирования/мягкого удаления постов.
- `messaging/` — личные сообщения между друзьями:
  - модели `DirectConversation`, `DirectConversationParticipant`, `DirectMessage`;
  - отдельная страница списка диалогов и страница конкретного диалога;
  - отправка сообщений с текстом и/или изображениями.
- `core/` — инфраструктурные вещи и поиск:
  - поиск по пользователям и постам (через `core.views.search`);
  - вспомогательные template‑tags для UI (например, формирование ссылок с якорями в ленте постов).
- `templates/` — HTML‑шаблоны:
  - базовый шаблон с общим оформлением;
  - страницы регистрации/логина, профиля, ленты постов, списка друзей, сообщений, поиска.
- `static/` — статические файлы (CSS, иконки, изображения интерфейса).
- `tests/` — все тесты проекта:
  - сквозные сценарии (`test_flows.py`);
  - проверка документации и Docker‑окружения (`test_docs_and_docker.py`);
  - дополнительные модульные тесты при необходимости.
- `Dockerfile`, `docker-compose.yml`, `.dockerignore`, `entrypoint.sh` — файлы контейнеризации и запуска.

---

## Features / Основные возможности

Функциональность приложения «Social Players» ориентирована на простой, но полноценный социальный опыт для игроков.

- **Регистрация и аутентификация**
  - Создание аккаунта по имени пользователя и паролю.
  - Вход/выход с использованием стандартных инструментов Django.
  - Защита приватных разделов (профиль, друзья, сообщения) через `login_required`.
- **Профили пользователей**
  - Автоматическое создание профиля при регистрации.
  - Редактирование профиля (отображаемое имя, биография, аватар).
  - Отображение статистики по друзьям и активности.
- **Друзья и заявки**
  - Отправка заявок в друзья другим пользователям.
  - Принятие, отклонение и отмена заявок.
  - Отображение списка друзей и возможность удалить друга.
- **Посты и лента**
  - Создание текстовых постов с выбором игрового топика (CS2, Valorant, Dota 2 и т.п.) или внегровой активности.
  - Прикрепление изображения к посту.
  - Лайки постов и их подсчёт.
  - Комментарии к постам, включая возможность прикрепить файл.
  - Мягкое удаление постов и комментариев (флаг `is_deleted` вместо физического удаления).
- **Личные сообщения**
  - Диалоги только между пользователями, состоящими в дружбе.
  - Отправка текстовых сообщений, изображений или сочетания текста и изображения.
  - Поддержка сообщений «только фото» — в списке диалогов такие сообщения отображаются как `Last: Photo`.
  - Отметки удаления сообщения для отправителя или получателя без физического удаления из базы.
- **Поиск**
  - Поиск по пользователям (логин и отображаемое имя).
  - Поиск по постам (текст и тематика).
  - Умная нормализация темы поста (поиск по slug и человекочитаемой метке).

---

## Пользовательские сценарии (flow‑ы)

Чтобы лучше понять работу приложения, ниже приведены основные сценарии, которые зафиксированы в тестах `tests/test_flows.py`.

- **Регистрация нового пользователя**
  - Пользователь заполняет форму регистрации.
  - Создаётся запись пользователя и связанный профиль.
  - Пользователь автоматически авторизуется и попадает в ленту.

- **Редактирование профиля**
  - Авторизованный пользователь заходит на страницу редактирования профиля.
  - Меняет отображаемое имя и, при желании, биографию/аватар.
  - После сохранения изменения видны в ленте и на странице профиля.

- **Работа с друзьями**
  - Пользователь A отправляет пользователю B заявку в друзья.
  - Пользователь B принимает заявку — создаётся запись дружбы.
  - Любой из пользователей может удалить другого из друзей.

- **Посты, лайки и комментарии**
  - Пользователь создаёт пост, выбирая тему и заполняя текст.
  - Другой пользователь ставит лайк, список лайков обновляется.
  - Тот же пользователь оставляет комментарий к посту.
  - В ленте отображаются актуальные лайки и комментарии.

- **Личные сообщения**
  - Два пользователя, состоящие в дружбе, открывают диалог.
  - Отправка текстового сообщения создаёт запись `DirectMessage`.
  - Отправка «пустого» сообщения (без текста и без изображения) не допускается — пользователь видит ошибку.
  - Вложение изображения без текста считается корректным сообщением; в списке диалогов превью отображается как «Last: Photo».

---

## Настройки окружения и конфигурация

Проект максимально прост и не использует сложной конфигурации через переменные окружения, за исключением Docker‑обвязки.

- **В обычном (не Docker) запуске:**
  - Секретный ключ и другие параметры заданы в `social_players/settings.py`.
  - Для production‑окружения рекомендуется:
    - создать отдельный модуль настроек;
    - или переопределять значения через переменную `DJANGO_SETTINGS_MODULE` и собственный файл настроек.
- **В Docker‑запуске:**
  - `DJANGO_SETTINGS_MODULE=social_players.settings` задаётся в `docker-compose.yml`;
  - миграции и (опционально) `collectstatic` выполняются через `entrypoint.sh`;
  - переменные `COLLECT_STATIC` и `DJANGO_COLLECTSTATIC` управляют запуском `python manage.py collectstatic --noinput`.

---

## Работа с базой данных

По умолчанию используется `sqlite` (файл `db.sql`), что делает проект полностью самодостаточным:

- Не требуется устанавливать отдельный сервер баз данных.
- Файл базы лежит в корне проекта и легко переносится вместе с кодом.
- Для разработки и тестирования этого достаточно.

Если вам нужен PostgreSQL или другая СУБД:

- Добавьте соответствующий драйвер в `requirements.txt` и адаптируйте `DATABASES` в `social_players/settings.py`.
- При использовании Docker удобнее добавить отдельный сервис БД в `docker-compose.yml` и настроить соединение.
- Не забывайте обновлять README и тесты при таких изменениях.

---

## Разработка и внесение изменений

Рекомендации по развитию проекта:

- Перед изменением кода запускайте существующие тесты (`pytest`), чтобы убедиться, что базовое поведение не сломано.
- После изменения логики добавляйте или обновляйте тесты, покрывающие новые сценарии.
- Для внесения визуальных правок:
  - редактируйте шаблоны в `templates/` и стили в `static/`;
  - при необходимости запускайте `collectstatic` в Docker‑окружении.

---

## Известные ограничения и возможные улучшения

На текущем этапе проект ограничен следующими факторами:

- Отсутствует полноценная система уведомлений (web‑socket, e‑mail и т.п.).
- Нагрузка и масштабируемость не учитывались — конфигурация ориентирована на учебные и небольшие проекты.
- Авторизация использует стандартную систему Django без сторонних OAuth‑провайдеров.
- Валидация форм минимальна и ориентирована на базовые кейсы.
